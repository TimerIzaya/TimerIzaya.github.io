---
layout:     post
title:      彻底拿下常量池和intern()问题
subtitle:   垃圾博客网课去死吧
date:       2021-12-15
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - Java
    - JVM

---

### 方法区到底是什么？

存储被虚拟机加载的类型信息，常量，代码缓存等数据。

JDK6以及之前，用永久代实现方法区，也就是方法区完全在堆外。

JDK7，把**常量池**移到堆里作为一个单独区域。

JDK8，完全废弃永久代，改为元空间，把永久代除了常量池剩余的内容（**主要是类型信息**）存储在内，元空间属于本地内存。



### 常量池到底是什么？

常量池主要有三种：Class文件常量池，运行时常量池，全局字符串常量池。

#### 1.Class文件常量池

Class字节码文件，对应着是编译后、但还没运行的java程序，除了有类版本、字段、方法、接口等描述信息以外，还有一个非常重要的**常量池表（Constant Pool Table）**，用于存放编译期间生成的**字面量和符号引用**，常量池表会在类加载完存放到**运行时常量池**中。

解释一下**字面量**和**符号引用**，对一个简单的程序，对其二进制字节码文件用javap反汇编一下。

```java
public class Test {
    
    private int value = 1;

    private String s = "wtf";

    public String get(String x){
        return s;
    }
}
```

```shell
javap -v Test.class
```

**具体的常量池表如下图**

<img src="https://gitee.com/timerizaya/timer-pic/raw/master/img/image-20211215172859529.png" alt="image-20211215172859529" style="zoom:67%;" /> 

- **字面量**：说白了就是加了双引号的可见常量，比如String s = "fuck"里的“fuck”。还有一种特殊就是final修饰的成员变量。所以加了双引号的字符串，在类加载完后会直接被加入**运行时常量池**。这类字面量在反汇编的时候，可以以**UTF8**的格式直接表示出来，比如上图中的：

  ```shell
   #3 = String             #25 
   #25 = Utf8               wtf
  ```

- **符号引用：**

  - **类和接口的全名**，把使用时候的 “.” 换为 “/” ，比如上图中的：

    ```shell
     #5 = Class              #27  
     #27 = Utf8              Test
    ```

  - **字段（也就是成员变量）的名称和描述符**，Class的常量池表仅仅保存字段的名，不保存值。比如上图中的：

    ```shell
    #2 = Fieldref           #5.#24
    #24 = NameAndType        #7:#8 
    #7 = Utf8               value
    #8 = Utf8               I
    ```

  - **方法的名称和描述符**，也就是参数类型和返回类型，比如上图中的：

    ```shell
    #19 = Utf8               (Ljava/lang/String;)Ljava/lang/String;
    ```

    
