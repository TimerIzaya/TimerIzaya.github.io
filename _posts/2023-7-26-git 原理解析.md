---
layout:     post
title:      Git原理解析
subtitle:   
date:       2023-7-26
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - Git

---

## **常用命令**

- git cat-file 可以查看object文件信息，blob、tree、commit
- git ls-files -s 可以查看index文件内容。

## **git add file 过程**

- object目录下生成blob文件：blob文件名=哈希过的file内容，内容=压缩过后的file内容
- index文件新增关联信息：file文件名 -> blob文件名

## **git status 过程**

- 遍历工作区文件，如果index中没找到某文件名，说明这个文件没被add，是untracked状态。
- 遍历工作区文件，如果index中找到某文件名，则计算该文件目前的hash，如果和index中的hash不同，说明这个文件被改过了，是modified状态。
- rename操作单独讨论。

## **git commit 过程**

- 生成tree对象。tree对象可包含blob和tree来代表当前文件夹。
- 生成commit对象。commit对象包含tree信息作为文件夹快照，以及parent commit信息将commit串联在一起。

## **HEAD 实现**

不断追踪即可发现HEAD本质为指向某一个commit对象的指针。

```shell
cat HEAD
```

```
ref: refs/heads/master
```

```shell
cat ./refs/heads/master
```

```
c625e4a113dd7872e2384c4c14b065d26c7df654
```

```shell
git cat-file -p c625
```

```shell
tree 6b6558b66ef5d993d968db7cd21bfc43770f6062
parent 113b8bfbdf98012d9d13b0ff95b0f7331ed98a17
author root <root@HIH-L-11940.cn.net.ntes> 1690338266 +0800
committer root <root@HIH-L-11940.cn.net.ntes> 1690338266 +0800

2st cm
```

## sha1已有碰撞案例

git的blob对象压缩方式是文件名+文件大小+文件内容，所以还相对安全，目前社区准备升级到sha256

## git 垃圾回收

- #### **情况1：多次add，一次commit，部分add带来的blob是不需要的**		

  ```shell
  echo "123" > test
  git add .
  echo "123456" > test
  git add .	
  git commit -m"1st commit"
  ```

  ```shell
  git fsck # 可以用来检索所有dangling对象
  ```

  ```
  Checking object directories: 100% (256/256), done.
  dangling blob 083ffd782654010fa81deb72ca8bd53e566331fe
  ```

  解决方案：

  ```shell
  git prune # 删除所有dangling对象
  ```

- #### **情况2：新建分支，进行ad、cm，后又删除，为了保证恢复，git不认为这是垃圾对象**

​	解决方案：https://stackoverflow.com/questions/3797907/how-to-remove-unused-objects-from-a-git-repository

- #### **情况3：反复commit一个做了微小修改的大文件**

  ```shell
  vi test # 写一个10M大文件
  git add .
  git cm -m"1st"
  vi test # 微小修改
  git add .
  git cm -m"2st"
  vi test # 微小修改
  git add .
  git cm -m"3st"
  ```

  此时object目录下有30M左右的文件

  解决方案：

  使用`git gc`把重复内容压缩到pack目录中

  ```shell
  git gc
  ```

  此时用verify-pack命令可以查看pack.idx文件具体信息

  ```shell
  git verify-pack -v .git/objects/pack/pack-606c016dbf7fcd4c040eb32057308e2ff3b8af8e.idx
  ```


## git rename

​	git diff关于rename的几个重要参数。

> -M[<n>]
> --find-renames[=<n>]
> Detect renames. If n is specified, it is a threshold on the similarity index (i.e. amount of addition/deletions compared to the file’s size). For example, -M90% means Git should consider a delete/add pair to be a rename if more than 90% of the file hasn’t changed. Without a % sign, the number is to be read as a fraction, with a decimal point before it. I.e., -M5 becomes 0.5, and is thus the same as -M50%. Similarly, -M05 is the same as -M5%. To limit detection to exact renames, use -M100%. The default similarity index is 50%.
>
> 该命令在全局参数中为git config diff.renameLimit <threshold>
>
> 
>
> -C[<n>]
>
> --find-copies[=<n>]
>
> Detect copies as well as renames. See also `--find-copies-harder`. If `n` is specified, it has the same meaning as for `-M<n>`.
>
> --find-copies-harder
>
> For performance reasons, by default, `-C` option finds copies only if the original file of the copy was modified in the same changeset. This flag makes the command inspect unmodified files as candidates for the source of copy. This is a very expensive operation for large projects, so use it with caution. Giving more than one `-C` option has the same effect.
>
> 
>
> -l<num>
> The -M and -C options involve some preliminary steps that can detect subsets of renames/copies cheaply, followed by an exhaustive fallback portion that compares all remaining unpaired destinations to all relevant sources. (For renames, only remaining unpaired sources are relevant; for copies, all original sources are relevant.) For N sources and destinations, this exhaustive check is O(N^2). This option prevents the exhaustive portion of rename/copy detection from running if the number of source/destination files involved exceeds the specified number. Defaults to diff.renameLimit. Note that a value of 0 is treated as unlimited.

​	-M 参数相关测试：



















