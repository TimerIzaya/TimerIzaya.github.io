---
layout:     post
title:      拿下MVCC
subtitle:   数据库的黑科技
date:       2021-12-11
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - Mysql
    - 数据库

---

## MVCC

全名为Muti-Version Concurrency Control，多版本并发控制。

在Mysql中，有两种视图的概念。

- **view** : 简单说就是拷贝的查询结果集
- **consistent read view** : InnoDB在实现MVCC使用的一致性读视图，用于支持RC（read committed，读提交）和RR（repeatable read，可重复读）隔离级别的实现。它没有物理结构，作用是确定事务执行期间**能看到什么数据。**



## 快照在MVCC里是怎么工作的？

在RR级别的隔离中，事务启动就要创建快照，如果一个库有100G，mysql不可能拷贝100G的数据出来做个快照。

这就是MVCC的黑科技。

InnoDB为每个事务创建了一个transaction_id，在事务开始时向事务系统申请，严格递增。

每个记录，也就是每个行都有一个多个版本。比如对于某行来说：

trx_id = 10，value = 100

trx_id = 15，value = 200

trx_id = 17，value = 500

trx_id = 25，value = 300

**undo log的作用也就提现出来了：回滚数据至这行当前可见的版本。**

所以想要一个当前事务的快照，只需要在访问当前行的数据时，回滚到事务启动前最新的版本，或者回滚到当前事务自己更新的版本。

在实现上，InnoDB为每个事务创建了一个数组，用于存储在当前事务启动时，其他已启动但没提交的事务ID。

