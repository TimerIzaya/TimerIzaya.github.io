---
layout:     post
title:      字节码与类加载
subtitle:   必学的天书
date:       2021-12-19
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - Java
    - JVM

---

## Class文件结构

Class文件由两种数据类型组成，无符号数和表。

- 无符号数：基本类型，由u1 u2 u3 u4 u8 代表对应的字节数。
- 表：多个无符号数或者其他表构成的复合类型，由“_info” 结尾。

#### Class文件格式：

| 类型           | 名称                | 作用                                 |
| -------------- | ------------------- | ------------------------------------ |
| u4             | magic               | 确认文件是Class文件                  |
| u2             | minor_version       | 次版本号                             |
| u2             | major_version       | 主版本号                             |
| u2             | constant_pool_count | 常量池数量                           |
| cp_info        | constant_pool       | 常量池                               |
| u2             | access_flags        | 访问修饰符                           |
| u2             | this_class          | 类索引，用于确定这个类的全限定名     |
| u2             | super_class         | 父类索引，用于确定父类的全限定名     |
| u2             | interfaces          | 和上面两个一起确定这个类的继承关系   |
| u2             | interfaces_count    | 接口数量                             |
| field_info     | fields              | 字段表                               |
| u2             | fields_count        | 字段表数量                           |
| method_info    | methods             | 方法表                               |
| u2             | methods_count       | 方法表数量                           |
| attribute_info | attributes          | 属性表，存额外信息，比如异常列表等等 |
| u2             | attributes_count    | 属性表数量                           |

#### 常用字节码命令：

| 操作码   | 作用                                                    |
| -------- | ------------------------------------------------------- |
| bipush   | int值入栈                                               |
| iconst_0 | 0(int)入栈                                              |
| iconst_1 | 同理，1(int)入栈                                        |
| ldc      | 常量池中数据入栈                                        |
| aload_x  | 把局部变量表中的x槽位的引用入栈                         |
| iload_x  | 把局部变量表中槽位x的int入栈                            |
| innc     | 把整数值constbyte加到indexbyte指定的int类型的局部变量里 |
| istore_x | 把int保存到局部变量x中                                  |
| iadd     | 将栈顶两int类型数相加，结果入栈。                       |

#### 实际运用：

```java
int x = 10;
int ans = x++ + ++x + x-- + --x;
```



| 操作           | 解释                             | 操作数栈(左栈底，右栈顶) | 局部变量表 |
| -------------- | -------------------------------- | ------------------------ | ---------- |
| bipush         | 10入操作数栈（**后续简称为栈**） | 10                       |            |
| istore_1       | 把栈顶的10放到局部变量表1的位置  |                          | 1:10       |
| **iload_1**    | 把局部变量表下标为1的数装载入栈  | 10                       | 1:10       |
| **iinc 1 1**   | 把局部变量表下标为1的数自增1     | 10                       | 1:11       |
| **iinc 1 1**   | 把局部变量表下标为1的数自增1     | 10                       | 1:12       |
| **iload_1**    | 把局部变量表下标为1的数装载入栈  | 10 12                    | 1:12       |
| iadd           | 将栈顶10和12相加，结果入栈       | 22                       | 1:12       |
| **iload_1**    | 把局部变量表下标为1的数装载入栈  | 22 12                    | 1:12       |
| **iinc 1, -1** | 把局部变量表下标为1的数自增-1    | 22 12                    | 1:11       |
| iadd           | 将栈顶22和11相加，结果入栈       | 34                       | 1:11       |
| **iinc 1, -1** | 把局部变量表下标为1的数自增-1    | 34                       | 1:10       |
| **iload_1**    | 把局部变量表下标为1的数装载入栈  | 34 10                    | 1:10       |
| iadd           | 将栈顶33和10相加，结果入栈       | 44                       | 1:10       |
| istore_2       | 把栈顶的43放到局部变量表2的位置  |                          | 1:10 2:44  |
| return         | 返回                             |                          | 1:10 2:44  |

变量表中1的位置是x，2的位置是ans，所以运行完，x = 10，ans = 44。

也可以从字节码的角度看出，x++和x--的区别在于：**先自增还是先入操作数栈**。























