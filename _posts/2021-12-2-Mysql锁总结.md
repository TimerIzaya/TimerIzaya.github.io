---
layout:     post
title:      Mysql锁总结
subtitle:   锁就完事了
date:       2021-12-2
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - Mysql
    - 数据库

---

## 全局锁

```mysql
Flush tables with read lock;
```

FTWRL，简单的说就是让整个数据库变为可读状态，所有DDL、增删改操作都会被阻塞。

![image-20211202220659031](https://gitee.com/timerizaya/timer-pic/raw/master/img/image-20211202220659031.png) 

对应的解锁语句为：

```mysql
unlock tables
```

全局锁主要用于全库逻辑备份，但是官方默认全库逻辑备份的工具是mysqldump。当用参数--single-transaction的时候，会启动一个事务，获得一致性视图。而由于MVCC 支持，这个过程可以正常更新。

顺便记录一波逻辑备份语句。

```shell
mysqldump -u[] -p[] [database] [table] > [file]; # 备份指定库-表
mysql -u[] -p[] [database] < [file]; #指定库导入
```

一致性读是很好，但是前提是引擎要支持可重复读的隔离级别。比如Myisam不支持事务，那么它备份时候的一致性就没法保证。所以必须要FTWRL了。

想要全库只读，还有一种方法是 **set global read_only = true**，直接修改配置。但是不推荐这样做。

- 有些系统要用全局变量来判断是否是主从。
- 异常处理机制有差异。如果是FTWRL的话，客户端异常断开，那么这个锁会被释放，不影响整个库。而设置read_only的话，则会一直保持只读状态，会导致长期不可写的状态，风险较大。

  

## 表级锁

表级的锁有两种，表锁和MDL（meta data lock）。

**表锁就是指定表的全局锁：**

```mysql
lock table q_bind read/write;

unlock tables #释放锁
```

对于Innodb这种支持行锁的引擎，一般不用这个。

**元数据锁：**

**元数据锁用来保证对象的并发访问时数据的一致性。**

当使用dml的时候，会增加对表的读锁，读锁之间不冲突。

当使用ddl的时候，会增加对表的写锁，写锁是独占的。

并且dml锁，是事务完全提交才会释放的。

**比如：**

事务1里全是dml语句，事务1执行。

之后事务2里全是dml语句，由于读锁不冲突，事务2同样并发执行。

之后事务3里有ddl语句，事务1和2还在执行，占用读锁，所以ddl阻塞。

可怕的是后续事务456里全是dml，同样被阻塞。

由于客户端的重连机制，超时后会再起一个session不断请求，那么线程很快就会爆满。

如果这个时候有一个小表，访问很频繁，但是又必须要加一个字段。那么比较理想的做法是：

**对ddl设置等待时间，如果在这个指定时间里拿不到锁，那么就放弃，一会儿继续请求。**

  



## 全局锁和表锁的总结：

- 全局锁主要用于逻辑备份。对于Innodb的引擎，用--single-transaction比较友好。
- 表锁一般是引擎不支持行锁才会用到。如果发现程序中有lock tables这种语句，那大概率可能是引擎还是MyISAM这种，没有更新。
- MDL直到事务结束才会释放，表结构更新的时候，注意不要阻塞DDL！

  



## 实际场景应用：

**当从库用--single-transaction逻辑备份的时候，如果从主库中binlog传来一个对表T的DDL会怎么样？**

先看逻辑备份的整体步骤：

```mysql
set session transaction isolation level repeatable read; #确保隔离级别为RR（虽然默认也是RR）

start transaction with consistent snapshot; #确保这句执行完就可以获得一个一致性视图，用于逻辑备份

savepoint sp; #开始备份，记录当前sp，防止中途表结构变化

show create table t; #获得表结构

select * from t; #导入数据

rollback to savepoint sp; #返回sp，表T备份结束

#开始备份其他表
```















































