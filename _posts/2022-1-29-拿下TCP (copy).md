---
layout:     post
title:      七层模型-网络层
subtitle:   网络一线牵
date:       2022-1-20
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - 计算机网络

---

## 前言

钻牛角尖太容易一环套一环了，想做个IM去学Netty，学Netty要学IO多路复用，学IO多路复用得看epoll实现原理，学完IO多路复用再用Reactor实现的时候，又会碰到一堆网络问题，各种沾包、丢包层出不穷，tcp这关是迟早要过了。



## 七层模型和四层模型

![img](https://gitee.com/timerizaya/timer-pic/raw/master/img/v2-2d62ba265be486cb94ab531912aa3b9c_720w.jpg)

首先，TCP在网络OSI的七层模型中的第四层——Transport层，IP在第三层——Network层，ARP在第二层——Data Link层。

在第四层的数据叫Segment，第二层上的数据叫Frame，第三层上的数据叫Packet。



## TCP和UDP的区别

- #### TCP面向连接，UDP不面向连接

  所谓连接，就是建立一定的数据结构来维持双方交互的状态。

- #### TCP面向字节流，UDP不面向流

  TCP发的时候是一个个流，没头没尾。UDP继承了IP，是一个个数据报。

- #### TCP有拥塞控制，UDP没有

  当有包丢弃或者网络环境不好，TCP会拥塞控制。而UDP不会，应用让它发，它就会一直发，不管网络什么情况。

**MAC层定义了局域网之间的传输行为，IP层定义了端对端的传输行为，这两层保证了：网络传输以包为单位，不管是二层的帧，还是三层包，还是四层段，统称为包。包单独传输，自选线路，在不同的设备中封装、解封，不保证到达。所以它的孩子UDP也是这样。**



## UDP的使用场景

1. #### 内网或丢包不敏感的应用

2. #### 需要广播的应用，比如DHCP协议就是基于UDP在内网进行广播的。



## 基于UDP的应用

1. #### QUIC（全称Quick UDP Internet Connections，快速 UDP 互联网连接）

   原来访问网页和手机 APP 都是基于 HTTP 协议的。HTTP 协议是基于 TCP 的，建立连接都需要多次交互，对于时延比较大的目前主流的移动互联网来讲，建立一次连接需要的时间会比较长。

   QUIC是 Google 提出的一种基于 UDP 改进的通信协议，其目的就是降低网络通信的延迟。

2. #### 流媒体协议

   很多直播应用，都基于 UDP 实现了自己的视频传输协议。

3. #### 实时游戏

   实时游戏中客户端和服务端要建立长连接，来保证实时传输。**一台机器能够支撑的 TCP 连接数目是有限的**， UDP是没有连接的，在异步 IO 机制引入之前，常常是应对海量客户端连接的策略。

   另外还是 TCP 的**强顺序问题**，如果出现一个数据包丢失，所有事情都需要停下来等待这个数据包重发。玩家并不关心过期的数据，打团卡一秒，人都没了。

   游戏对实时要求较为严格的情况下，采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。

4. #### 物联网

   物联网领域终端资源少，很可能只是个内存非常小的嵌入式系统，而**维护 TCP 协议代价太大**。

   另一方面，物联网对实时性要求也很高，而 TCP 还是因为上面的那些原因导致**时延大**。

   Google 旗下的Nest 建立 Thread Group，推出了物联网通信协议 Thread，就是基于 UDP 协议的。

5. #### 移动通信

   在 4G 网络里，移动流量上网的数据面对的协议 GTP-U 是基于 UDP 的。因为移动网络协议比较复杂，而 GTP 协议本身就包含复杂的手机上线下线的通信协议。如果基于 TCP，TCP 的机制就显得非常多余。



















## TCP头的格式

![image-20220129222610428](https://gitee.com/timerizaya/timer-pic/raw/master/img/image-20220129222610428.png)

#### 需要注意的点是：

- **Sequence Number** ：用于解决包乱序问题
- **Acknowledgement Number**：就是ACK，用于确认收到，**用来解决丢包的问题**。
- **Window** ：又叫Advertised-Window**，也就是著名的滑动窗口（Sliding Window），**用于解决流控的。
- **TCP Flag** ：也就是包的类型，**主要是用于操控TCP的状态机的**。

#### 其他位置的信息如下：

![image-20220129225345516](https://gitee.com/timerizaya/timer-pic/raw/master/img/image-20220129225345516.png)





















