---
layout:     post
title:      彻底拿下HashMap和ConcurrentHashMap（待续）
subtitle:   复盘学习顶级JAVA大佬的思维
date:       2021-9-16
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - JDK


---

## 前提： HashMap在JDK中的结构层次

先来一张Java.Util包的类结构（可打开大图）

![](https://gitee.com/timerizaya/timer-pic/raw/master/img/Package%20util.png)

Util里主要容器类就是Collection和Map，先研究Map这一块，Map容器系列设计结构如下。

![](https://gitee.com/timerizaya/timer-pic/raw/master/img/20210916153537.png)

#### Map：Map接口设计好了所有Map基础操作的方法。

#### AbstractMap：

​    **关键注释：This class provides a skeletal implementation of the Map interface, to minimize the effort required to implement this interface.To implement an unmodifiable map, the programmer needs only to extend this class and provide an implementation for the entrySet method, which returns a set-view of the map's mappings.  To implement a modifiable map, the programmer must additionally override this class's put method (which otherwise throws an UnsupportedOperationException)。**

**简要概括：这个类提供了Map接口的简单实现，目的是让后续实现这个类的时候少费点功夫。**

AbstractMap仅有一个抽象方法：

![](https://gitee.com/timerizaya/timer-pic/raw/master/img/20210916162353.png)

要想实现一个不可修改的Map（视图Map），只需要继承这个类，实现这个方法，这样就可以返回这个map的视图了。

要想实现一个可修改的Map（正常使用的Map），就必须要实现这个类的put方法。因为AbstractMap默认自己是个视图Map。



**看源码看到这里，想吐槽一点，JDK里有的不可变Map，也就是Collections.UnmodifiableMap。只实现了Map接口，并没有继承这个类，两个类的作者是一个人，自己都不用自己写的类，离谱。**

```java
 private static class UnmodifiableMap<K,V> implements Map<K,V>, Serializable {
     //实现
 }
```

**所以到头来，Abstract的作用就只在于：实现了很多Map的基础方法，子类的其他Map，比如Hashmap、TreeMap等，可以选择性的覆盖。** 

但是实际上呢？HashMap、TreeMap，真的用到了AbstractMap里写的方法了吗？

Map里最关键的get()和put()方法，put()没写，get()也仅仅是循环Entry找到目标Key，和没写一样。

去StackOverFlow翻了一圈，有个类似的问题：

**Why does LinkedHashSet<E> extend HashSet<e> and implement Set<E>**

下面有个JDK作者的朋友回复了：

**I've asked Josh Bloch, and he informs me that it was a mistake. He used to think, long ago, that there was some value in it, but he since "saw the light". Clearly JDK maintainers haven't considered this to be worth backing out later.**

"Mistake"解决了所有疑问。所以，HashMap其实只实现Map接口就行了，不用考虑AbstractMap。   



# 正篇：

## 1.HashMap总体结构

从结构实现来讲，HashMap是数组+链表+红黑树（JDK1.8增加了红黑树部分）实现的。

<img src="https://awps-assets.meituan.net/mit-x/blog-images-bundle-2016/e4a19398.png" alt="img" style="zoom:25%;" /> 





123123

