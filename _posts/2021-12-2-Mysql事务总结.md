---
layout:     post
title:      Mysql锁总结
subtitle:   锁就完事了
date:       2021-12-2
author:     Timer
header-img: img/the-first.png
catalog: false
tags:
    - Mysql
    - 数据库

---

## 全局锁：

```mysql
Flush tables with read lock;
```

FTWRL，简单的说就是让整个数据库变为可读状态，所有DDL、增删改操作都会被阻塞。

![image-20211202220659031](https://gitee.com/timerizaya/timer-pic/raw/master/img/image-20211202220659031.png) 

对应的解锁语句为：

```mysql
unlock tables
```

全局锁主要用于全库逻辑备份，但是官方默认全库逻辑备份的工具是mysqldump。当用参数--single-transaction的时候，会启动一个事务，获得一致性视图。而由于MVCC 支持，这个过程可以正常更新。

顺便记录一波逻辑备份语句。

```shell
mysqldump -u[] -p[] [database] [table] > [file]; # 备份指定库-表
mysql -u[] -p[] [database] < [file]; #指定库导入
```

一致性读是很好，但是前提是引擎要支持可重复读的隔离级别。比如Myisam不支持事务，那么它备份时候的一致性就没法保证。所以必须要FTWRL了。

想要全库只读，还有一种方法是 **set global read_only = true**，直接修改配置。但是不推荐这样做。

- 有些系统要用全局变量来判断是否是主从。
- 异常处理机制有差异。如果是FTWRL的话，客户端异常断开，那么这个锁会被释放，不影响整个库。而设置read_only的话，则会一直保持只读状态，会导致长期不可写的状态，风险较大。

























